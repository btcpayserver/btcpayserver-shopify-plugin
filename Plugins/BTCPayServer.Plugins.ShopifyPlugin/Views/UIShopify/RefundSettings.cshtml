@using BTCPayServer.Abstractions.Contracts
@using BTCPayServer.Abstractions.Extensions
@using BTCPayServer.Abstractions.Models
@using BTCPayServer.Plugins.ShopifyPlugin
@using BTCPayServer.Plugins.ShopifyPlugin.ViewModels
@using Microsoft.AspNetCore.Routing
@using BTCPayServer.Plugins.ShopifyPlugin.Blazor
@inject IScopeProvider ScopeProvider
@model ShopifyRefundWebhookSettingsViewModel
@{
    var storeId = ScopeProvider.GetCurrentStoreId();
    ViewData.SetLayoutModel(new LayoutModel("Shopify-Refund", "Shopify Refund Settings") { ActiveCategory = "ShopifyV2" });
    var storeEmailSettingsConfigured = (bool)ViewData["StoreEmailSettingsConfigured"];
    Layout = "_Layout";
}

<div class="sticky-header">
    <h2 class="my-1">
        @ViewData["Title"]
        <small>
            <a href="https://docs.btcpayserver.org/ShopifyV2/#shopify-refunds" target="_blank" rel="noreferrer noopener"
               title="@StringLocalizer["More information..."]">
                <vc:icon symbol="info" />
            </a>
        </small>
    </h2>
    <div class="d-flex gap-3 mt-3 mt-sm-0">
        <button type="submit" form="refundSettingsForm" class="btn btn-primary" @(storeEmailSettingsConfigured ? "" : "disabled")>
            Save Settings
        </button>
    </div>
</div>
<partial name="_StatusMessage" />

<div class="mt-4">
    <div class="row">
        <div class="col-lg-8">
            <div class="alert alert-info">
                <p class="mb-2">
                    This webhook notifies BTCPay Server when a refund occurs for orders paid via BTCPay Server,
                    and sends a secure claim link to the customer by email.
                </p>
                <p class="mb-2">
                    Copy the webhook URL below and paste it into your Shopify Admin dashboard.
                </p>
                <ul class="mb-2">
                    <li>Go to <strong>Settings → Notifications → Webhooks</strong></li>
                    <li>Create a webhook for the <strong>Refund create</strong> event</li>
                    <li>Set the format to <strong>JSON</strong></li>
                    <li>Use Webhook API version <strong>2026-01</strong></li>
                </ul>
            </div>

            <form id="refundSettingsForm" asp-action="RefundSettings" asp-route-storeId="@storeId" method="post">
                <div class="mb-4">
                    <label class="form-label fw-bold">Webhook URL</label>
                    <div class="input-group">
                        <input type="text" class="form-control" value="@Model.WebhookUrl" readonly />
                        <button type="button" class="btn btn-outline-secondary clipboard-button" data-clipboard="@Model.WebhookUrl">
                            <vc:icon symbol="actions-copy" />
                        </button>
                    </div>
                </div>
                <div class="mb-4">
                    <label asp-for="WebhookSecret" class="form-label fw-bold">Webhook Secret</label>
                    <input asp-for="WebhookSecret" class="form-control" placeholder="Enter your Shopify webhook secret" />
                    <span asp-validation-for="WebhookSecret" class="text-danger"></span>
                    <div class="form-text">
                        Your webhook secret is displayed on the webhook page
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold">Refund Option Method</label>
                    <span asp-validation-for="SelectedRefundOption" class="text-danger"></span>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" asp-for="SelectedRefundOption" value="CurrentRate" id="refundCurrentRate" />
                        <label class="form-check-label" for="refundCurrentRate"> Use current exchange rate at time of refund</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" asp-for="SelectedRefundOption" value="RateThen" id="refundRateThen" />
                        <label class="form-check-label" for="refundRateThen">Use exchange rate at time of original payment</label>
                    </div>
                </div>

                <div class="mb-4">
                    <label asp-for="SpreadPercentage" class="form-label fw-bold">Refund Spread Percentage</label>
                    <div class="input-group">
                        <input asp-for="SpreadPercentage" type="number" class="form-control" step="0.01" min="0" max="100" placeholder="e.g. 2.5" />
                        <span asp-validation-for="SpreadPercentage" class="text-danger"></span>
                        <span class="input-group-text">%</span>
                    </div>
                    <div class="form-text">
                        Optional. This percentage will be deducted from the refund amount to account for exchange rate volatility.
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>